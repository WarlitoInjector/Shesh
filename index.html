<!-- FIREBASE SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc,
  deleteDoc,
  doc,
  onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBBEQe3_cC9CWej-cDCZ9HMUzSj0xwtMi0",
  authDomain: "shesh-c86b5.firebaseapp.com",
  projectId: "shesh-c86b5",
  storageBucket: "shesh-c86b5.firebasestorage.app",
  messagingSenderId: "403916968425",
  appId: "1:403916968425:web:9bff1dd6eb0c8def257b78",
  measurementId: "G-7M1BC9L6J4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const censusCollection = collection(db, "residents");

let people = [];

// ================= FUNCTIONS =================
function formatName(name){
  return name.toLowerCase().replace(/\b\w/g,c=>c.toUpperCase());
}

function calculateAge(b){
  let t=new Date(),birth=new Date(b);
  let age=t.getFullYear()-birth.getFullYear();
  let m=t.getMonth()-birth.getMonth();
  if(m<0||(m===0&&t.getDate()<birth.getDate()))age--;
  return age;
}

function randomColor(){
  return "#"+Math.floor(Math.random()*16777215).toString(16);
}

// ================= REALTIME =================
onSnapshot(censusCollection, (snapshot)=>{
  people = [];
  snapshot.forEach(docSnap=>{
    people.push({ id: docSnap.id, ...docSnap.data() });
  });
  renderTable();
});

// ================= RENDER =================
function renderTable(){
  let table=document.getElementById("dataTable");
  table.innerHTML="";

  people.forEach((p)=>{
    let age=calculateAge(p.birthdate);
    let tags="";

    if(p.status==="Voter")tags+="<span class='badge badge-blue'>Voter</span>";
    if(p.status==="Student")tags+="<span class='badge badge-yellow'>Student</span>";
    if(p.status==="Employed")tags+="<span class='badge badge-green'>Employed</span>";
    if(age>=60)tags+="<span class='badge badge-blue'>Senior</span>";

    table.innerHTML+=`
    <tr>
      <td><div class='avatar' style='background:${randomColor()}'>${p.gender==="Male"?"M":"F"}</div></td>
      <td>${p.fullname}</td>
      <td>${age}</td>
      <td>${p.civilstatus}</td>
      <td>${tags}</td>
      <td>
        <button onclick="editData('${p.id}')">Edit</button>
        <button onclick="deleteData('${p.id}')">Delete</button>
      </td>
    </tr>`;
  });
}

// ================= ADD / UPDATE =================
document.getElementById("censusForm").addEventListener("submit", async function(e){
  e.preventDefault();

  let selectedStatus=document.querySelector('input[name="status"]:checked');

  let person={
    fullname:formatName(fullname.value),
    gender:gender.value,
    birthdate:birthdate.value,
    civilstatus:civilstatus.value,
    status:selectedStatus?selectedStatus.value:null
  };

  if(editIndex.value===""){
    await addDoc(censusCollection, person);
  }else{
    await updateDoc(doc(db,"residents",editIndex.value), person);
    editIndex.value="";
  }

  this.reset();
});

// ================= EDIT =================
window.editData = function(id){
  let p = people.find(x=>x.id===id);
  fullname.value=p.fullname;
  gender.value=p.gender;
  birthdate.value=p.birthdate;
  civilstatus.value=p.civilstatus;

  document.querySelectorAll('input[name="status"]').forEach(r=>{
    r.checked = r.value===p.status;
  });

  editIndex.value=id;
}

// ================= DELETE =================
window.deleteData = async function(id){
  if(confirm("Delete this resident?")){
    await deleteDoc(doc(db,"residents",id));
  }
}

</script>
